<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - EchoVerse</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/favicon.svg') }}">
    {% if session.get('user') or session.get('user_id') %}
    <link rel="prefetch" href="{{ url_for('home') }}">
    <link rel="prefetch" href="{{ url_for('explore') }}">
    {% if is_admin %}
    <link rel="prefetch" href="{{ url_for('admin_panel') }}">
    {% endif %}
    {% endif %}
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/home.css">
</head>
<body>
    {% include "_header.html" %}

    <div class="container" style="grid-template-columns: 1fr; max-width: 1100px; margin: 0 auto; flex: 1;">
        <main class="feed" style="width: 100%; max-width: 100%;">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="profile-avatar-section">
                    {% set avatar_url = user.avatar if user.avatar and not user.avatar.startswith('http') else (user.avatar if user.avatar else None) %}
                    {% set alt_text = user.name %}
                    {% set avatar_class = 'profile-avatar' %}
                    {% include "__avatar.html" %}
                    <script>
                        // Update avatar preview ID for the profile page
                        document.querySelector('.profile-avatar').id = 'avatar-preview';
                    </script>
                    {% if is_own_profile %}
                    <form method="POST" action="{{ url_for('update_avatar') }}" enctype="multipart/form-data" class="avatar-form">
                        <label class="file-upload-label">
                            <input type="file" name="avatar_file" accept="image/*" class="avatar-file-input" id="avatar-file-input" style="display: none;">
                            <span class="file-upload-text">Choose Image</span>
                        </label>
                        <button type="submit" class="btn btn-small">Update Avatar</button>
                    </form>
                    {% endif %}
                </div>
                <div class="profile-info">
                    <h1>{{ user.name }}</h1>
                    <p class="profile-email">{{ user.email }}</p>
                    {% if user.bio %}
                    <p class="profile-bio">{{ user.bio }}</p>
                    {% endif %}
                    <div class="profile-stats">
                        {% set stat_value = post_count %}{% set stat_label = 'Posts' %}{% include "_stat_item.html" %}
                        {% set stat_value = following %}{% set stat_label = 'Following' %}{% include "_stat_item.html" %}
                        {% set stat_value = followers %}{% set stat_label = 'Followers' %}{% include "_stat_item.html" %}
                    </div>
                    {% if not is_own_profile %}
                    <div class="profile-actions" style="margin-top: var(--space-4); display: flex; gap: var(--space-3);">
                        <form method="POST" action="{{ url_for('toggle_follow', user_id=user.id) }}" style="display: inline;">
                            <button type="submit" class="btn {{ 'btn-secondary' if is_following else '' }}">
                                {{ 'Unfollow' if is_following else 'Follow' }}
                            </button>
                        </form>
                        <form method="POST" action="{{ url_for('toggle_user_block', user_id=user.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to {{ 'unblock' if is_blocked_by_viewer else 'block' }} this user?');">
                            <button type="submit" class="btn" style="background-color: var(--color-error); color: white;">
                                {{ 'Unblock' if is_blocked_by_viewer else 'Block' }}
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tabs -->
            <div class="profile-tabs">
                {% if is_own_profile %}
                <button class="tab-btn active" onclick="showTab('edit')">Edit Profile</button>
                <button class="tab-btn" onclick="showTab('posts')">My Posts</button>
                {% else %}
                <button class="tab-btn active" onclick="showTab('posts')">Posts</button>
                {% endif %}
            </div>

            <!-- Edit Profile Tab -->
            {% if is_own_profile %}
            <div id="edit-tab" class="tab-content active">
                <div class="profile-sections">
                    <!-- Update Bio -->
                    <section class="profile-section">
                        <h2>Update Bio</h2>
                        <form method="POST" action="{{ url_for('update_bio') }}" class="profile-form">
                            <textarea name="bio" placeholder="Tell us about yourself..." maxlength="500" class="profile-textarea">{{ user.bio or '' }}</textarea>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="char-count" id="bio-count">0/500</span>
                                <button type="submit" class="btn btn-primary">Update Bio</button>
                            </div>
                        </form>
                    </section>

                    <!-- Update Name -->
                    <section class="profile-section">
                        <h2>Update Name</h2>
                        <form method="POST" action="{{ url_for('update_name') }}" class="profile-form" id="update-name-form">
                            <input type="text" name="name" value="{{ user.name }}" placeholder="Name" required 
                                   minlength="2" maxlength="100" pattern=".{2,100}" 
                                   title="Name must be between 2 and 100 characters" class="profile-input">
                            <button type="submit" class="btn btn-primary">Update Name</button>
                        </form>
                        <script>
                            // Front-end validation for name update
                            document.getElementById('update-name-form')?.addEventListener('submit', function(e) {
                                const name = this.querySelector('input[name="name"]').value.trim();
                                if (name.length < 2 || name.length > 100) {
                                    e.preventDefault();
                                    alert('Name must be between 2 and 100 characters');
                                    return false;
                                }
                            });
                        </script>
                    </section>

                    <!-- Update Email -->
                    <section class="profile-section">
                        <h2>Update Email</h2>
                        <p class="section-note">A verification email will be sent to your new email address.</p>
                        <form method="POST" action="{{ url_for('update_email') }}" class="profile-form" id="update-email-form">
                            <input type="email" name="email" value="{{ user.email }}" placeholder="Email" required 
                                   pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" 
                                   title="Please enter a valid email address" class="profile-input">
                            <button type="submit" class="btn btn-primary">Update Email</button>
                        </form>
                        <script>
                            // Front-end validation for email update
                            document.getElementById('update-email-form')?.addEventListener('submit', function(e) {
                                const email = this.querySelector('input[name="email"]').value.trim();
                                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                                if (!emailRegex.test(email)) {
                                    e.preventDefault();
                                    alert('Please enter a valid email address');
                                    return false;
                                }
                            });
                        </script>
                    </section>

                    <!-- Change Password -->
                    <section class="profile-section">
                        <h2>Change Password</h2>
                        <p class="section-note">A verification email will be sent to your email address to change your password.</p>
                        <form method="POST" action="{{ url_for('change_password') }}" class="profile-form">
                            <button type="submit" class="btn btn-primary">Send Password Change Link</button>
                        </form>
                    </section>

                    <!-- Delete Account -->
                    <section class="profile-section" style="border: 2px solid var(--color-error);">
                        <h2 style="color: var(--color-error);">Delete Account</h2>
                        <p class="section-note" style="color: var(--color-error);">
                            Permanently delete your account and all associated data. This action cannot be undone.
                        </p>
                        <a href="{{ url_for('delete_account') }}" class="btn" style="background-color: var(--color-error); color: white;">Delete Account</a>
                    </section>
                </div>
            </div>
            {% endif %}

            <!-- Posts Tab -->
            <div id="posts-tab" class="tab-content {{ 'active' if not is_own_profile else '' }}">
                <div class="profile-posts">
                    {% if posts %}
                        {% for post in posts %}
                        <article class="post-card" id="post-{{ post.id }}">
                            <div class="post-header">
                                {% set avatar_url = user.avatar if user.avatar and not user.avatar.startswith('http') else (user.avatar if user.avatar else None) %}
                                {% set alt_text = user.name %}
                                {% set avatar_class = 'avatar' %}
                                {% include "__avatar.html" %}
                                <div class="post-author">
                                    <a href="{{ url_for('profile', profile_user_id=user.id) }}" class="author-name">{{ user.name }}</a>
                                    <span class="post-time">{{ post.created_at.strftime('%b %d, %Y at %I:%M %p') if post.created_at else '' }}</span>
                                </div>
                            </div>
                            
                            <!-- Post View Mode -->
                            <div class="post-view" id="post-view-{{ post.id }}">
                                {% if post.content %}
                                <div class="post-content">
                                    {{ post.content }}
                                </div>
                                {% endif %}
                                
                                {% if post.media_type == 'audio' and post.media_path %}
                                <div class="post-audio">
                                    <audio controls class="audio-player">
                                        <source src="{{ url_for('static', filename='uploads/' + post.media_path) }}" type="audio/mpeg">
                                        Your browser does not support the audio element.
                                    </audio>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Post Edit Mode (hidden by default) -->
                            <div class="post-edit" id="post-edit-{{ post.id }}" style="display: none;">
                                <form method="POST" action="{{ url_for('edit_post', post_id=post.id) }}" enctype="multipart/form-data" class="inline-edit-form">
                                    <textarea name="content" rows="3" class="inline-edit-input" placeholder="Share your sound...">{{ post.content or '' }}</textarea>
                                    
                                    {% if post.media_type == 'audio' and post.media_path %}
                                    <div style="margin: var(--space-3) 0;">
                                        <p style="color: var(--color-text-muted); font-size: 0.85rem; margin-bottom: var(--space-2);">Current audio:</p>
                                        <audio controls class="audio-player" style="width: 100%;">
                                            <source src="{{ url_for('static', filename='uploads/' + post.media_path) }}" type="audio/mpeg">
                                        </audio>
                                        <p style="color: var(--color-text-muted); font-size: 0.85rem; margin-top: var(--space-2);">
                                            Upload new file to replace, or leave empty to keep current audio.
                                        </p>
                                    </div>
                                    {% endif %}
                                    
                                    <label class="file-upload-label" style="margin: var(--space-3) 0;">
                                        <input type="file" name="audio_file" accept="audio/*" style="display: none;">
                                        <span class="file-upload-text">üéµ {% if post.media_type == 'audio' %}Replace Audio{% else %}Upload Audio{% endif %}</span>
                                    </label>
                                    
                                    <div class="inline-edit-actions">
                                        <button type="submit" class="btn btn-primary btn-small">Save</button>
                                        <button type="button" class="btn btn-small" onclick="cancelEdit({{ post.id }})">Cancel</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="post-actions">
                                    <button type="button" class="action-btn {% if post.user_liked %}liked{% endif %}" onclick="toggleLike({{ post.id }})" id="like-btn-{{ post.id }}">
                                    <span class="like-icon">{% if post.user_liked %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span> <span id="like-count-{{ post.id }}">{{ post.total_likes or 0 }}</span>
                                </button>
                                <button class="action-btn" onclick="toggleComments({{ post.id }})" id="comment-btn-{{ post.id }}">
                                    üí¨ Comment <span id="comment-count-{{ post.id }}">{% if post.comment_count %}({{ post.comment_count }}){% endif %}</span>
                                </button>
                                {% if is_own_profile %}
                                <button class="action-btn" onclick="toggleEdit({{ post.id }})">‚úèÔ∏è Edit</button>
                                <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" class="action-form" onsubmit="return confirm('Are you sure you want to delete this post?');">
                                    <button type="submit" class="action-btn delete-btn">üóëÔ∏è Delete</button>
                                </form>
                                {% endif %}
                            </div>
                            
                            <!-- Comments Section (hidden by default) -->
                            <div class="comments-section" id="comments-{{ post.id }}" style="display: none;">
                            <form method="POST" action="{{ url_for('add_comment', post_id=post.id) }}" class="comment-form" id="comment-form-{{ post.id }}" onsubmit="return addComment(event, {{ post.id }})">
                                <input type="text" name="content" placeholder="Write a comment..." class="comment-input" 
                                       required maxlength="500" minlength="1" 
                                       title="Comment must be between 1 and 500 characters">
                                <button type="submit" class="btn btn-small">Post</button>
                            </form>
                                <div class="comments-list">
                                    {% if post.comments %}
                                        {% for comment_item in post.comments %}
                                            {% set comment = comment_item %}
                                            {% include "__comment.html" %}
                                        {% endfor %}
                                    {% else %}
                                        <p style="color: var(--color-text-muted); font-size: 0.9rem; padding: var(--space-3);">No comments yet. Be the first to comment!</p>
                                    {% endif %}
                                </div>
                            </div>
                        </article>
                        {% endfor %}
                    {% else %}
                        <div class="empty-feed">
                            <p>You haven't posted anything yet. <a href="{{ url_for('home') }}">Share your first sound!</a></p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>

    <script>
        // Preview avatar file upload
        const avatarFileInput = document.getElementById('avatar-file-input');
        const avatarPreview = document.getElementById('avatar-preview');
        
        if (avatarFileInput && avatarPreview) {
            avatarFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        avatarPreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Bio character counter
        const bioTextarea = document.querySelector('textarea[name="bio"]');
        const bioCount = document.getElementById('bio-count');
        if (bioTextarea && bioCount) {
            bioTextarea.addEventListener('input', function() {
                bioCount.textContent = this.value.length + '/500';
            });
            // Set initial count
            bioCount.textContent = bioTextarea.value.length + '/500';
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        // Inline post editing
        function toggleEdit(postId) {
            const postView = document.getElementById('post-view-' + postId);
            const postEdit = document.getElementById('post-edit-' + postId);
            
            if (postView && postEdit) {
                postView.style.display = postView.style.display === 'none' ? 'block' : 'none';
                postEdit.style.display = postEdit.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function cancelEdit(postId) {
            const postView = document.getElementById('post-view-' + postId);
            const postEdit = document.getElementById('post-edit-' + postId);
            
            if (postView && postEdit) {
                postView.style.display = 'block';
                postEdit.style.display = 'none';
                // Reset form
                const form = postEdit.querySelector('form');
                if (form) {
                    form.reset();
                }
            }
        }
        
        function toggleComments(postId) {
            const commentsSection = document.getElementById('comments-' + postId);
            if (commentsSection) {
                commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
            }
        }
    </script>

    {% include "_footer.html" %}
    
    <script src="/static/js/home.js"></script>
</body>
</html>

